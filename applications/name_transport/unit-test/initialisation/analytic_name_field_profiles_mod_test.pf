!-----------------------------------------------------------------------------
! (c) Crown copyright 2025 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> Test the analytic initial field computation in the name app

module analytic_name_field_profiles_mod_test

  use constants_mod, only : i_def, r_def
  use funit

  implicit none

  private
  public :: set_up, tear_down, &
            analytic_name_field_test

contains

  !----------------------------------------------------------------------------
  @before
  subroutine set_up()

    use extrusion_config_mod, only : method_uniform, &
                                     stretching_method_linear
    use feign_config_mod,     only : feign_extrusion_config,          &
                                     feign_initial_name_field_config, &
                                     feign_planet_config

    implicit none

    call feign_extrusion_config( method=method_uniform,                      &
                                 planet_radius=6000000.0_r_def,              &
                                 domain_height=10.0_r_def,                   &
                                 number_of_layers=5_i_def,                   &
                                 stretching_method=stretching_method_linear, &
                                 stretching_height=10.0_r_def,               &
                                 eta_values=(/0.5_r_def/) )

    call feign_planet_config( gravity=10.0_r_def,    &
                              omega=8.0E-5_r_def,    &
                              rd=300.0_r_def,        &
                              cp=1000.0_r_def,       &
                              p_zero=100000.0_r_def, &
                              scaling_factor=1.0_r_def )

    call feign_initial_name_field_config( field_background=0.0_r_def, &
                                          field_max=1.0_r_def,        &
                                          r1=1.0_r_def, x1=2.0_r_def, &
                                          y1=3.0_r_def, z1=4.0_r_def, &
                                          r2=1.0_r_def, x2=0.0_r_def, &
                                          y2=0.0_r_def, z2=0.0_r_def )

  end subroutine set_up

  !----------------------------------------------------------------------------
  @after
  subroutine tear_down()

    use configuration_mod,        only: final_configuration

    implicit none

    call final_configuration()

  end subroutine tear_down

  !----------------------------------------------------------------------------
  @test
  subroutine analytic_name_field_test()

    use, intrinsic :: iso_fortran_env,      only : real64
    use analytic_name_field_profiles_mod,   only : analytic_name_field
    use idealised_config_mod,               only : test_yz_cosine_hill

    implicit none

    real(kind=r_def) :: rho
    real(kind=r_def) :: chi(3)
    real(kind=r_def) :: tol
    real(kind=r_def), parameter :: domain_max_x = 2.0_r_def

    ! Set chi field
    chi = (/ 2.0_r_def,3.25_r_def,4.5_r_def /)
    ! Compute NAME density for cosine hill test
    rho = analytic_name_field( chi, test_yz_cosine_hill, &
                               domain_max_x )
    if ( r_def == real64 ) then
       tol = 10.0E-12_r_def
    else
       tol = 10.0_r_def * spacing( rho )
    endif
    @assertEqual(0.407826538399892_r_def, rho, tol)

  end subroutine analytic_name_field_test

end module analytic_name_field_profiles_mod_test
